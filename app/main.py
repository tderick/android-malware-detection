import tempfile
import json
from fastapi import FastAPI, File, UploadFile, HTTPException, Response

from .feature_extractor import APKFeatureExtractor
    
app = FastAPI(
    title="Android Malware Detection",
    summary="Malware Detection API using Machine Learning",
    description="This API is used to detect malware in Android applications using Machine Learning. Users have to submit APK file and the API will return the result of the detection (Malware or Benign).",
    version="0.0.1",
)



@app.post('/api/v1/android-malware-detection')
async def android_malware_detection(file: UploadFile = File(...)):
    
    if not file.filename.endswith(".apk"):
        raise HTTPException(status_code=400, detail="Only APK files are allowed")

      # Create a temporary file in memory
    with tempfile.NamedTemporaryFile(delete=False, suffix=".apk") as temp_file:
        # Write the content of the uploaded file to the temporary file
        content = await file.read()  # Read the file content from UploadFile
        temp_file.write(content)  # Write the content to the temporary file
        
        # Get the path of the temporary file
        temp_file_path = temp_file.name

    rs = APKFeatureExtractor(temp_file_path).extract_features()

    json_response = json.dumps(rs)
    return Response(content=json_response,media_type="application/json")
    

